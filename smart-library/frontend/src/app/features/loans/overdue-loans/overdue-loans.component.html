<div class="min-h-screen bg-gray-50 p-6">
  <p-toast />
  <p-confirmDialog />

  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6 flex justify-between items-center">
      <div class="flex items-center gap-4">
        <button
          pButton
          icon="pi pi-arrow-left"
          class="p-button-text p-button-secondary"
          (click)="goBack()"
          pTooltip="Back to Dashboard"
          tooltipPosition="bottom"
          aria-label="Back to dashboard"
        ></button>
        <div>
          <h1 class="text-3xl font-bold text-gray-800">Overdue Loans</h1>
          <p class="text-sm text-gray-600 mt-1">
            Manage and track overdue book returns
          </p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <p-tag
          [value]="filteredLoans.length + ' Overdue'"
          severity="danger"
          styleClass="text-lg px-4 py-2"
        />
      </div>
    </div>

    <!-- Alert Banner -->
    <div
      *ngIf="filteredLoans.length > 0"
      class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded"
    >
      <div class="flex items-center">
        <i class="pi pi-exclamation-triangle text-red-500 text-xl mr-3"></i>
        <div>
          <h3 class="font-semibold text-red-800">Attention Required</h3>
          <p class="text-sm text-red-700">
            There are {{ filteredLoans.length }} overdue loan(s) that need immediate attention.
            Please contact the users or mark books as returned.
          </p>
        </div>
      </div>
    </div>

    <!-- Search Card -->
    <p-card class="mb-6">
      <div class="flex-1">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Search by book, user name, or email
        </label>
        <span class="p-input-icon-left w-full">
          <i class="pi pi-search"></i>
          <input
            type="text"
            pInputText
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            placeholder="Search overdue loans..."
            class="w-full"
          />
        </span>
      </div>
    </p-card>

    <!-- Overdue Loans Table -->
    <p-card>
      <p-table
        [value]="filteredLoans"
        [loading]="loading"
        [paginator]="true"
        [rows]="10"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} overdue loans"
        [rowsPerPageOptions]="[10, 25, 50]"
        styleClass="p-datatable-sm"
        [tableStyle]="{ 'min-width': '70rem' }"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="user.name">
              User <p-sortIcon field="user.name" />
            </th>
            <th>Contact</th>
            <th pSortableColumn="book.title">
              Book Title <p-sortIcon field="book.title" />
            </th>
            <th pSortableColumn="book.author">
              Author <p-sortIcon field="book.author" />
            </th>
            <th pSortableColumn="due_date">
              Due Date <p-sortIcon field="due_date" />
            </th>
            <th pSortableColumn="days_overdue">
              Days Overdue <p-sortIcon field="days_overdue" />
            </th>
            <th>Actions</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-loan>
          <tr class="bg-red-50">
            <td>
              <div class="font-semibold">{{ loan.user?.name || 'N/A' }}</div>
            </td>
            <td>
              <div class="text-sm text-gray-600">
                {{ loan.user?.email || 'N/A' }}
              </div>
            </td>
            <td>
              <div class="font-semibold">{{ loan.book?.title || 'N/A' }}</div>
            </td>
            <td>{{ loan.book?.author || 'N/A' }}</td>
            <td>
              <div class="text-red-600 font-medium">
                {{ loan.due_date | date: 'MMM dd, yyyy' }}
              </div>
            </td>
            <td>
              <p-tag
                [value]="(loan.days_overdue || 0) + ' days'"
                [severity]="getSeverityByDays(loan.days_overdue || 0)"
                styleClass="font-bold"
              />
            </td>
            <td>
              <div class="flex gap-2">
                <button
                  pButton
                  icon="pi pi-check"
                  class="p-button-success p-button-sm"
                  pTooltip="Mark as Returned"
                  tooltipPosition="top"
                  (click)="returnBook(loan)"
                  aria-label="Return book"
                ></button>
                <button
                  pButton
                  icon="pi pi-envelope"
                  class="p-button-info p-button-sm"
                  pTooltip="Send Reminder"
                  tooltipPosition="top"
                  (click)="sendReminder(loan)"
                  aria-label="Send reminder"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center py-8">
              <div class="text-gray-500">
                <i class="pi pi-check-circle text-4xl text-green-500 mb-3"></i>
                <p class="text-lg">No overdue loans</p>
                <p class="text-sm">
                  {{
                    searchTerm
                      ? 'No results found for your search'
                      : 'All books have been returned on time!'
                  }}
                </p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>

    <!-- Statistics Card -->
    <div *ngIf="filteredLoans.length > 0" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <p-card>
        <div class="text-center">
          <i class="pi pi-clock text-3xl text-orange-500 mb-2"></i>
          <h3 class="text-2xl font-bold text-gray-800">
            {{ getOverdueWithin7Days() }}
          </h3>
          <p class="text-sm text-gray-600">Within 7 Days</p>
        </div>
      </p-card>

      <p-card>
        <div class="text-center">
          <i class="pi pi-exclamation-circle text-3xl text-red-500 mb-2"></i>
          <h3 class="text-2xl font-bold text-gray-800">
            {{ getOverdueMoreThan7Days() }}
          </h3>
          <p class="text-sm text-gray-600">More Than 7 Days</p>
        </div>
      </p-card>

      <p-card>
        <div class="text-center">
          <i class="pi pi-users text-3xl text-blue-500 mb-2"></i>
          <h3 class="text-2xl font-bold text-gray-800">
            {{ getUniqueUsersCount() }}
          </h3>
          <p class="text-sm text-gray-600">Affected Users</p>
        </div>
      </p-card>
    </div>
  </div>
</div>
